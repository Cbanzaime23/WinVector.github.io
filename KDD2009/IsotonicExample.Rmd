---
title: "IsotonicExample"
author: "John Mount"
date: "August 30, 2015"
output: html_document
---


```{r}
library('ggplot2')

source('Lfns.R')

set.seed(235725)
d <- data.frame(x=rnorm(20))
d$y <- (d$x+rnorm(nrow(d)))>0
d$isTrain <- runif(nrow(d))>0.5
m <- glm(y~x,data=d[d$isTrain,],family=binomial)
d$predL <- predict(m,newdata=d,type='link')
d$pred <- predict(m,newdata=d,type='response')

dTrain <- d[d$isTrain,]
dTest <- d[!d$isTrain,]

# learn inverse link function from data (but, can't be any better than
# logistic's link for this example).
dTrain$iso <- solveIsotonicProblem(dTrain$y,dTrain$predL)

iso1 <- solveIsotonicProblem(dTrain$y,predict(m,newdata=dTrain,type='link'))
iso2 <- solveIsotonicProblem(dTrain$y,predict(m,newdata=dTrain,type='response'))

# repeat adjustment mapping on new data
mapIso <- function(trainOrig,trainAdjusted,newOrig) {
  # limit down to unique values
  breaks <- sort(unique(trainOrig))
  uposns <- match(breaks,trainOrig)
  trainOrig <- trainOrig[uposns]
  trainAdjusted <- trainAdjusted[uposns]
  newidx <- findInterval(newOrig,trainOrig)
  newidx <- pmax(1,newidx)
  trainOrig[[1+length(trainOrig)]] <- 1+trainOrig[[length(trainOrig)]] 
  trainAdjusted[[1+length(trainAdjusted)]] <- trainAdjusted[[length(trainAdjusted)]]
  lambda <- (newOrig-trainOrig[newidx])/(trainOrig[newidx+1]-trainOrig[newidx])
  newAdjusted <- (1-lambda)*trainAdjusted[newidx] + lambda*trainAdjusted[newidx+1]
  newAdjusted           
}



d$iso <- mapIso(dTrain$pred,dTrain$iso,d$predL)
dTest$iso <- mapIso(dTrain$pred,dTrain$iso,dTest$predL)


# show iso is a non-decreasing function of predL
ggplot(data=d,aes(x=predL,y=iso,color=y)) +
  geom_point(alpha=0.5)

# show iso is no further from y
ggplot(data=dTrain,aes(x=pred,color=y)) + 
  geom_density() + 
  ggtitle(paste("train outcome by pred, deviance",
                devianceNYP(dTrain$y,dTrain$pred)))
ggplot(data=dTrain,aes(x=iso,color=y)) +
  geom_density() + 
  ggtitle(paste("train outcome by iso adjusted pred, deviance,",
                devianceNYP(dTrain$y,dTrain$iso)))

ggplot(data=dTest,aes(x=pred,color=y)) + 
  geom_density() + 
  ggtitle(paste("test outcome by pred, deviance",
                devianceNYP(dTest$y,dTest$pred)))
ggplot(data=dTest,aes(x=iso,color=y)) +
  geom_density() + 
  ggtitle(paste("test outcome by iso adjusted pred, deviance,",
                devianceNYP(dTest$y,dTest$iso)))
```

